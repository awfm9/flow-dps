# Flow Data Provisioning Service

The Flow Data Provisioning Service aims at providing a scalable and efficient way to access the execution state of past
and live sporks, as well as implementing the Rosetta API standard.

Past sporks are loaded from the filesystem using Flow's Write-Ahead Log to replay the changes to all registries, and
updates are pushed directly to the DPS by the execution nodes in order to handle live networks.

The Flow DPS maintains different specialized indexes for different purposes. One index is used for accessing the entire
execution state at any given height, while the other is used to follow the history of a specific registry through time.
Contrary to Flow's WAL, those indexes allow replaying changes both backward and forward, which enables visualization
beyond a network's pruned blocks.

Another role of the DPS is to provide information about atomic transactions which are not normally generated by Flow, by
locally running Cadence scripts on the copy of the execution state. This makes it possible to link an account with its
staked balance, locked token vaults etc. and to expose that information in the API.

## Road Map

| Milestone |                  Description                  | Past Spork State | Past Spork Events | Live Spork State | Live Spork Events | Raw API | Ledger API | Rosetta API | Liquid Balance | Locked Balance | Staked Balance | Delegated Balance | State Verification | State Proofs |
|:---------:|:---------------------------------------------:|:----------------:|-------------------|------------------|-------------------|---------|------------|-------------|----------------|----------------|----------------|-------------------|--------------------|--------------|
|    P.1    |        Past Spork support for registers       |         X        |                   |                  |                   |    X    |      X     |             |        X       |                |                |                   |                    |              |
|    P.2    |         Past Spork support with events        |         X        |         X         |                  |                   |    X    |      X     |             |        X       |                |                |                   |                    |              |
|    R.1    |    Rosetta API support for default balance    |         X        |         X         |                  |                   |    X    |      X     |      X      |        X       |                |                |                   |                    |              |
|    L.1    |        Live Spork support for registers       |         X        |         X         |         X        |                   |    X    |      X     |      X      |        X       |                |                |                   |                    |              |
|    L.2    |         Live Spork support with events        |         X        |         X         |         X        |         X         |    X    |      X     |      X      |        X       |                |                |                   |                    |              |
|    R.2    | Rosetta API support with sub-account balances |         X        |         X         |         X        |         X         |    X    |      X     |      X      |        X       |        X       |        X       |         X         |                    |              |
|    C.1    |   Cryptographic Verification of local state   |         X        |         X         |         X        |         X         |    X    |      X     |      X      |        X       |        X       |        X       |         X         |          X         |              |
|    C.2    |  Cryptographic Proofs for remote state access |         X        |         X         |         X        |         X         |    X    |      X     |      X      |        X       |        X       |        X       |         X         |          X         |       X      |

## Architecture

### Components

The Flow Data Provisioning Service is constituted of three main components.

The **indexer** is at the core of the service. It indexes deltas into its own data structures and provides a low level
API to expose its state.
The **mapper** synchronizes the **indexer** with a source of deltas (`FilesystemChain` or `NetworkChain`.)
The **chain** is in charge of fetching block sequence data (from a WAL in the filesystem for past sporks, or a network
socket for live ones.)

### Diagram

The following diagram describes a simple overview of an example where the DPS is reading from two sporks. One of them
is a live one, which sends

```text
┌─────────────────┐
│                 │
│   Past Spork    │
│                 │
│  ┌───────────┐  │             ┌───────┐
│  │           │  │             │       │
│  │ Exec Node ├──┼────────────►│ WALog │
│  │           │  │             │       │
│  └───────────┘  │             └───┬───┘
│                 │                 │
│                 │                 │
└─────────────────┘                 │
                                    ▼
                      ┌─────────────────────────────┐
                      │  FSChain / LedgerWALMapper  │
                      ├────────────▼▼▼──────────────┤
                      │                             │                          ┌──────────┐
                      │                             │  `GET /account/balance`  │          │
                      │  DATA PROVISIONING SERVICE  │◄─────────────────────────┤  Client  │
                      │          INDEXER            │                          │          │
                      │                             │                          └──────────┘
                      │                             │
                      ├────────────▲▲▲──────────────┤
                      │  NetworkChain / LiveMapper  │
                      └─────────────────────────────┘
                                    ▲
                                    │
┌─────────────────┐                 │
│                 │                 │
│  Live Network   │                 │
│                 │                 │
│  ┌───────────┐  │                 │
│  │           │  │  `POST /block`  │
│  │ Exec Node ├──┼─────────────────┘
│  │           │  │
│  └───────────┘  │
│                 │
│                 │
└─────────────────┘
```
